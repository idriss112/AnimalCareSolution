@model AnimalCare.Models.UserProfileViewModel

@{
    ViewData["Title"] = "My Profile";
}

<div class="row">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="mb-0">
                    <i class="bi bi-person-circle text-primary"></i> My Profile
                </h2>
                <p class="text-muted mb-0">Update your personal information and password</p>
            </div>
        </div>

        <form asp-action="Profile" method="post" id="profileForm">
            @if (ViewData.ModelState.ErrorCount > 0 && ViewData.ModelState[""]?.Errors.Count > 0)
            {
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState[""]!.Errors)
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            <!-- SECURITY VERIFICATION FIRST -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-shield-lock-fill"></i> Security Verification
                </div>
                <div class="card-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Enter your current password to unlock editing.</strong>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label asp-for="CurrentPassword" class="form-label">
                                <i class="bi bi-key-fill"></i> Current Password <span class="text-danger">*</span>
                            </label>
                            <input asp-for="CurrentPassword"
                                   class="form-control"
                                   id="currentPasswordInput"
                                   autocomplete="current-password" />
                            <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                            <div id="passwordFeedback" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PERSONAL INFORMATION (LOCKED INITIALLY) -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-lines-fill"></i> Personal Information
                    <span id="lockedIndicator" class="badge bg-warning float-end">
                        <i class="bi bi-lock-fill"></i> Locked
                    </span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="FirstName" class="form-label"></label>
                            <input asp-for="FirstName" class="form-control editable-field" disabled />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="LastName" class="form-label"></label>
                            <input asp-for="LastName" class="form-control editable-field" disabled />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row mb-0">
                        <div class="col-md-6">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" class="form-control editable-field" type="email" disabled />
                            <span asp-validation-for="Email" class="text-danger"></span>
                            <small class="text-muted">Changing your email will also change your login username.</small>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="PhoneNumber" class="form-label"></label>
                            <input asp-for="PhoneNumber" class="form-control editable-field" disabled />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHANGE PASSWORD (LOCKED INITIALLY) -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-lock-fill"></i> Change Password (Optional)
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>Leave these fields blank if you don't want to change your password.</strong>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label asp-for="NewPassword" class="form-label"></label>
                            <input asp-for="NewPassword" class="form-control editable-field" autocomplete="new-password" disabled />
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="ConfirmPassword" class="form-label"></label>
                            <input asp-for="ConfirmPassword" class="form-control editable-field" autocomplete="new-password" disabled />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTION BUTTONS (DISABLED INITIALLY) -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary btn-lg" id="saveButton" disabled>
                    <i class="bi bi-save"></i> Save Changes
                </button>
                <a asp-controller="Home" asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- SIDEBAR -->
    <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-info text-white">
                <i class="bi bi-info-circle"></i> Account Information
            </div>
            <div class="card-body">
                <p>
                    <strong>Role:</strong>
                    @if (User.IsInRole("Admin"))
                    {
                        <span class="badge bg-danger">Admin</span>
                    }
                    else if (User.IsInRole("Veterinarian"))
                    {
                        <span class="badge bg-success">Veterinarian</span>
                    }
                    else if (User.IsInRole("Receptionist"))
                    {
                        <span class="badge bg-primary">Receptionist</span>
                    }
                </p>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <i class="bi bi-lightbulb"></i> How It Works
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2"><strong>Enter your current password</strong> first</li>
                    <li class="mb-2">Fields will unlock after verification</li>
                    <li class="mb-2">Make your changes</li>
                    <li class="mb-0">Click Save Changes</li>
                </ol>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            let passwordVerified = false;

            // Monitor current password input
            $('#currentPasswordInput').on('input', function() {
                const password = $(this).val();

                if (password.length >= 6) {
                    // Verify password with server
                    $.ajax({
                        url: '@Url.Action("VerifyPassword", "Account")',
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        },
                        contentType: 'application/json',
                        data: JSON.stringify(password),
                        success: function(response) {
                            if (response.success) {
                                // Password is correct
                                passwordVerified = true;
                                $('#passwordFeedback').html('<div class="alert alert-success py-2"><i class="bi bi-check-circle-fill"></i> Password verified! You can now edit.</div>');

                                // Enable all fields
                                $('.editable-field').prop('disabled', false);
                                $('#saveButton').prop('disabled', false);
                                $('#lockedIndicator').html('<i class="bi bi-unlock-fill"></i> Unlocked').removeClass('bg-warning').addClass('bg-success');
                            } else {
                                // Password is incorrect
                                passwordVerified = false;
                                $('#passwordFeedback').html('<div class="alert alert-danger py-2"><i class="bi bi-x-circle-fill"></i> Incorrect password</div>');

                                // Disable all fields
                                $('.editable-field').prop('disabled', true);
                                $('#saveButton').prop('disabled', true);
                                $('#lockedIndicator').html('<i class="bi bi-lock-fill"></i> Locked').removeClass('bg-success').addClass('bg-warning');
                            }
                        },
                        error: function() {
                            passwordVerified = false;
                            $('#passwordFeedback').html('<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle-fill"></i> Error verifying password</div>');
                        }
                    });
                } else {
                    // Password too short
                    passwordVerified = false;
                    $('#passwordFeedback').html('');
                    $('.editable-field').prop('disabled', true);
                    $('#saveButton').prop('disabled', true);
                    $('#lockedIndicator').html('<i class="bi bi-lock-fill"></i> Locked').removeClass('bg-success').addClass('bg-warning');
                }
            });

            // Prevent form submission if password not verified
            $('#profileForm').on('submit', function(e) {
                if (!passwordVerified) {
                    e.preventDefault();
                    alert('Please verify your current password first.');
                    return false;
                }
            });
        });
    </script>
}
